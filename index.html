<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <!-- jQuery Toast Plugin CSS -->
  <!-- Using native Bootstrap Toasts (remove jquery-toast-plugin) -->
  <title>Test Autocomplete</title>
  <style>
    :root {
      /* Palette */
      --ice-cold: #a0d2eb;
      --freeze-purple: #e5eaf5;
      --medium-purple: #d0bdf4;
      --purple-pain: #8458B3;
      --heavy-purple: #a28089;

      /* Mapped theme tokens */
      --bg: var(--freeze-purple);
      --panel: #ffffff;
      --muted: #6b6d83; /* slightly desaturated purple-gray */
      --text: #22223b;
      --border: #dcdff0;
      --accent: var(--purple-pain);
      --accent-2: var(--medium-purple);
      --shadow: 0 6px 16px rgba(0,0,0,.12);
    }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji"; padding: 28px; background: var(--bg); color: var(--text); }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji"; padding: 28px; background: var(--bg); color: var(--text); }
    .wrap { max-width: 1200px; margin: 0 auto; }
    .header-row { display:flex; align-items:center; justify-content: space-between; gap: 8px; margin-bottom: 10px; }
    .linklike { background: transparent; border: none; color: var(--muted); cursor: pointer; text-decoration: underline; padding: 4px 6px; border-radius: 6px; }
    .linklike { background: transparent; border: none; color: var(--muted); cursor: pointer; text-decoration: underline; padding: 4px 6px; border-radius: 6px; }
    .linklike:hover { color: var(--text); background: rgba(0,0,0,.03); }
    input[type="text"] { width: 100%; padding: 12px 14px; border: 1px solid var(--border); border-radius: 10px; font-size: 15px; background: var(--panel); color: var(--text); outline: none; }
    input[type="text"]::placeholder { color: #94a3b8; }
    select { padding: 10px 12px; border-radius: 10px; background: var(--panel); color: var(--text); border: 1px solid var(--border); }
    button { padding: 8px 12px; border-radius: 10px; border: 1px solid var(--border); background: #ffffff; color: var(--text); cursor: pointer; }
    button:hover { background: #f3f4f6; }
  /* Bootstrap buttons themed with palette */
  .btn-primary { background-color: var(--purple-pain); border-color: var(--purple-pain); }
  .btn-primary:hover, .btn-primary:focus { background-color: #734aa1; border-color: #734aa1; }
  .btn-outline-secondary { color: var(--purple-pain); border-color: var(--medium-purple); }
  .btn-outline-secondary:hover, .btn-outline-secondary:focus { background-color: var(--medium-purple); color: #fff; border-color: var(--medium-purple); }
  .q-wrap { position: relative; }
  .list { position: absolute; top: calc(100% + 6px); left: 0; right: 0; background: #ffffff; border: 1px solid var(--border); border-radius: 10px; box-shadow: var(--shadow); overflow: hidden; max-height: 360px; overflow-y: auto; z-index: 1040; }
    .item { display: flex; align-items: center; gap: 8px; padding: 10px 12px; cursor: pointer; color: var(--text); }
    .item + .item { border-top: 1px solid var(--border); }
  .item:hover, .item.active { background: rgba(132, 88, 179, .12); box-shadow: inset 3px 0 0 var(--accent-2); }
  .item.active { font-weight:600; }
    .item span { flex: 1; min-width: 0; }
    .item strong { color: var(--purple-pain); }
    .badge { font-size: 11px; border: 1px solid var(--border); color: var(--muted); padding: 2px 6px; border-radius: 999px; background: #fff; }
    /* Suggestion appear animation */
    @keyframes fadeSlide { from { opacity:0; transform: translateY(4px);} to { opacity:1; transform: translateY(0);} }
  /* Removed animation on .list .item per request */
  /* (previous) .list .item { animation: fadeSlide .28s ease forwards; } */
    /* Responsive input grids */
    .inputs-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .query-grid { display: grid; grid-template-columns: 1fr auto; gap: 8px; }
    #results .card { border: 1px solid var(--border); border-radius: var(--radius); background: #fff; box-shadow: var(--shadow); }
    @media (max-width: 720px) {
      .inputs-grid, .query-grid { grid-template-columns: 1fr; }
    }
    .hint { color: var(--muted); font-size: 13px; margin-top: 10px; }
    #results .card { border: 1px solid var(--border); border-radius: var(--radius); background: var(--panel); box-shadow: var(--shadow); }

    /* Modal */
  /* Custom modal (namespaced to avoid Bootstrap conflicts) */
  .ai-modal-backdrop { position: fixed; inset: 0; background: rgba(0, 0, 0, .35); display: none; align-items: center; justify-content: center; z-index: 1055; }
  .ai-modal { width: min(880px, 92vw); max-height: min(80vh, 980px); overflow: auto; background: #fff; border: 1px solid var(--border); border-radius: 12px; box-shadow: var(--shadow); }
  .ai-modal header { display:flex; align-items:center; justify-content: space-between; padding: 14px 16px; border-bottom: 1px solid var(--border); position: sticky; top: 0; background: linear-gradient(180deg, #fff, rgba(255,255,255,.9)); }
  .ai-modal header h3 { margin: 0; font-size: 16px; color: var(--text); }
  .ai-modal header .close { border: none; background: transparent; color: var(--muted); font-size: 20px; line-height: 1; padding: 4px 8px; cursor: pointer; }
  .ai-modal header .close:hover { color: var(--text); background: rgba(0,0,0,.05); border-radius: 8px; }
  .ai-modal .content { padding: 14px 16px 18px; }
  .ai-modal .content h4 { margin: 14px 0 6px; font-size: 14px; color: var(--purple-pain); }
  .ai-modal .content p, .ai-modal .content li { color: #424a60; font-size: 14px; line-height: 1.6; }
  .ai-modal .content code, .ai-modal .content kbd { background: var(--freeze-purple); border: 1px solid var(--border); padding: 0 6px; border-radius: 6px; }

  /* Results styling */
  #results { display: grid; grid-template-columns: 1fr; gap: 10px; }
  @media (min-width: 900px) { #results { grid-template-columns: 1fr 1fr; } }
  .result-card { border: 1px solid var(--border); border-radius: 12px; background: var(--panel); box-shadow: var(--shadow); padding: 12px 14px; transition: border-color .2s, transform .06s ease-in-out; }
  .result-card:hover { border-color: var(--accent-2); transform: translateY(-1px); }
  .result-content { display: flex; gap: 12px; align-items: flex-start; }
  .result-img { width: 64px; height: 64px; object-fit: cover; border-radius: 8px; border: 1px solid var(--border); background: var(--freeze-purple); flex-shrink: 0; }
  .result-title { font-weight: 600; color: var(--text); overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; }
  .result-meta { color: var(--muted); font-size: 13px; margin-top: 2px; }
  .result-price { color: var(--purple-pain); font-weight: 600; margin-top: 6px; }
  /* Autocomplete highlight styles */
  .suggest-frag { font-weight: 400; }
  .suggest-hit { font-weight: 700; }

  /* Two-column layout */
  .layout { display:flex; gap:26px; align-items:flex-start; }
  /* Enlarge custom phrase (admin) area */
  .main-col { flex: 0 1 48%; min-width:0; }
  .admin-col { flex: 0 0 52%; max-width:780px; background: var(--panel); border:1px solid var(--border); padding:16px 18px 20px; border-radius:14px; box-shadow: var(--shadow); position:sticky; top:16px; transition: background .25s, color .25s; }
  /* Taller scrollable phrase list */
  .admin-col #cp_list { max-height: 520px; overflow:auto; scrollbar-width: thin; }
    .admin-col #cp_list::-webkit-scrollbar { width:8px; }
    .admin-col #cp_list::-webkit-scrollbar-thumb { background: #c9c9d4; border-radius:5px; }
    .admin-col #cp_list::-webkit-scrollbar-track { background: transparent; }
    /* Collapsed state for mobile (will be toggled via class) */
    .admin-col.collapsed { display:none; }
    .admin-col h3 { margin-top:0; }
    @media (max-width: 1000px) {
      .layout { flex-direction: column; }
      .main-col { flex:1 1 auto; }
      .admin-col { flex:1 1 auto; width:auto; position:static; }
    }
    /* Dark mode base (will toggle a body class) */
    body.dark {
      --bg: #1f2330;
      --panel: #272c3a;
      --text: #e6e9f2;
      --border: #384154;
      --muted: #9aa3b5;
      --accent: #b18cff;
      --accent-2: #8e76d9;
      color: var(--text);
      background: var(--bg);
    }
    body.dark .result-card { background: var(--panel); }
    body.dark .admin-col { background: var(--panel); }
    body.dark input, body.dark select, body.dark button { background: #2f3544; color: var(--text); border-color: var(--border); }
    body.dark .list { background: var(--panel); }
    body.dark .item.active { background: rgba(177,140,255,.15); }
    body.dark .hint { color: var(--muted); }

    /* Skeleton loader for custom phrases */
    .sk-row { display:flex; justify-content:space-between; align-items:center; padding:6px 8px; border-bottom:1px solid var(--border); }
    .sk-left { flex:1; }
    .sk-line { height:12px; border-radius:6px; background: linear-gradient(90deg, var(--freeze-purple), var(--panel), var(--freeze-purple)); background-size:200% 100%; animation: skShine 1.1s linear infinite; margin:4px 0; }
    .sk-line.w60 { width:60%; }
    .sk-line.w40 { width:40%; }
    .sk-line.w30 { width:30%; }
    .sk-line.w80 { width:80%; }
    @keyframes skShine { 0% { background-position: 0 0;} 100% { background-position: -200% 0;} }

    /* Highlight inside admin list (search filter) */
    .cp-hit { background: rgba(132,88,179,.18); color: var(--text); padding:0 2px; border-radius:4px; font-weight:500; }

  /* Bootstrap toast customization */
  .toast-container { position: fixed; top: 16px; right: 16px; z-index: 4000; display:flex; flex-direction:column; gap:10px; }
  .toast { border-radius:12px; border:1px solid var(--border); background: var(--panel); box-shadow: var(--shadow); }
  .toast .toast-body { font-size:14px; display:flex; flex-direction:column; gap:8px; }
  .toast.bg-success { background: #22c55e; color:#fff; border-color:#16a34a; }
  .toast.bg-danger { background: #ef4444; color:#fff; border-color:#dc2626; }
  .toast-actions { display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap; }
  body.dark .toast { background:#2f3544; color:var(--text); border-color: var(--border); }
  body.dark .toast.bg-success { background:#16a34a; }
  body.dark .toast.bg-danger { background:#b91c1c; }
  pre.toast-pre { margin:0; font-size:12px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; white-space:pre-wrap; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header-row">
      <h2>Test Autocomplete</h2>
      <button id="howItWorksBtn" class="linklike" title="Xem cách hoạt động">How it works…</button>
    </div>
    <div class="layout">
      <div class="main-col">
        <div class="row inputs-grid">
          <input id="apiBase" class="form-control" type="text" placeholder="API base (vd: https://pepeapi-vv2pcyowoa-as.a.run.app)" value="https://pepeapi-vv2pcyowoa-as.a.run.app" />
          <input id="token" class="form-control" type="text" placeholder="Authorization token (vd: Pepeiscool hoặc Bearer ...)" value="Pepeiscool" />
        </div>
        <div style="height: 8px"></div>
        <div class="hint">Endpoint: <span id="endpointPreview">GET https://pepeapi-vv2pcyowoa-as.a.run.app/api/search/suggest_keywords?query=...</span></div>
        <div class="row query-grid" style="margin-top:6px;">
          <div class="q-wrap">
            <div style="display:flex; gap:6px; width:100%; align-items:center;">
              <input id="q" class="form-control" type="text" placeholder="Gõ thử: r, roy, royal, thuc... (Enter hoặc kính lúp)" autocomplete="off" />
              <button id="btnSearchNow" type="button" class="btn btn-primary" title="Tìm ngay (gọi /api/search)">🔍</button>
            </div>
            <div class="list" id="list" style="display:none"></div>
          </div>
          <select id="limit" class="form-select" title="Số kết quả / trang">
            <option value="10" selected>10</option>
            <option value="20">20</option>
            <option value="50">50</option>
          </select>
        </div>
        <div class="row" style="margin-top:8px; gap:12px; flex-wrap:wrap; align-items:center;">
          <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
            <button id="btnStats1d" class="btn btn-outline-secondary" title="GET /api/search/suggest_stats">Stats 24h</button>
            <button id="btnToggleAdmin" class="btn btn-outline-secondary" title="Hiện/ẩn khu vực Admin">Ẩn Admin</button>
            <button id="btnDarkMode" class="btn btn-outline-secondary" title="Dark / Light">Dark</button>
          </div>
          <div style="display:flex; gap:14px; flex-wrap:wrap; align-items:center;">
            <label style="margin:0; font-size:13px;"><input type="checkbox" id="showTypeScore" /> Hiện type/score</label>
            <label style="margin:0; font-size:13px;"><input type="checkbox" id="autoTrackClick" checked /> Auto click track</label>
            <span id="latencyInfo" class="hint" style="min-width:80px;"></span>
          </div>
        </div>
        <div style="height: 18px"></div>
        <div id="resultsWrap" style="display:none">
          <div id="resultsHeader" class="row" style="justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
            <div style="display:flex; gap:6px; align-items:center; font-size:15px;">
              <strong>Kết quả</strong>
              <span id="queryEcho" style="color:#6b7280"></span>
            </div>
            <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap;">
              <button id="prevBtn" class="btn btn-outline-secondary" style="padding:6px 10px;">«</button>
              <div style="font-size:14px; min-width:66px; text-align:center;">Trang <span id="pageNum">1</span></div>
              <button id="nextBtn" class="btn btn-outline-secondary" style="padding:6px 10px;">»</button>
            </div>
          </div>
          <div id="didYouMeanWrap" class="hint" style="display:none; margin-top:6px;"></div>
          <div id="results" style="margin-top:8px;"></div>
        </div>
      </div>
      <div class="admin-col" id="adminSection">
        <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:6px;">
          <h3 style="margin:0; font-size:18px;">Admin</h3>
          <div style="display:flex; gap:6px;">
            <button id="tabCustomPhrases" class="btn btn-sm btn-primary" type="button">Custom Phrases</button>
            <button id="tabSpellOverrides" class="btn btn-sm btn-outline-secondary" type="button">Spell Overrides</button>
            <button id="btnProtectSet" class="btn btn-sm btn-outline-secondary" type="button" title="Xem danh sách protect">Protect Set</button>
          </div>
          <div id="spellOverrideActions" style="display:none; gap:6px; margin-left:auto;">
            <button id="so_reload" class="btn btn-sm btn-outline-secondary" title="Reload override cache">Reload Cache</button>
            <button id="so_new" class="btn btn-sm btn-primary" title="Thêm override">Thêm / Update</button>
          </div>
        </div>
        <div id="protectSetPanel" style="display:none; border:1px solid var(--border); padding:10px 12px; border-radius:8px; margin-bottom:10px; max-height:300px; overflow:auto; background:#fff;">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
            <strong style="font-size:14px;">Protect Set <span id="protectSetStats" style="font-weight:400; color:#6b7280;"></span></strong>
            <button type="button" id="protectSetClose" class="btn btn-sm btn-outline-secondary" style="padding:4px 10px;">Đóng</button>
          </div>
          <div style="margin-top:8px; display:flex; gap:6px; flex-wrap:wrap; align-items:center;">
            <input id="protectSetFilter" type="text" placeholder="Lọc nhanh" style="flex:1; min-width:160px; padding:6px 8px; border:1px solid var(--border); border-radius:8px;" />
            <button id="protectSetRefresh" class="btn btn-sm btn-outline-secondary" type="button" title="Refresh" style="padding:6px 10px;">↻</button>
          </div>
          <div id="protectSetList" style="margin-top:8px; display:grid; grid-template-columns: repeat(auto-fill,minmax(140px,1fr)); gap:6px;"></div>
        </div>
        <div id="spellOverrideFormWrap" style="display:none; border:1px solid var(--border); padding:10px 12px; border-radius:8px; margin-bottom:10px;">
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
            <div>
              <label style="font-size:12px; color:#6b7280;">Token (gõ sai)</label>
              <input id="so_token" type="text" placeholder="vd: thucc" />
            </div>
            <div>
              <label style="font-size:12px; color:#6b7280;">Override (đúng)</label>
              <input id="so_override" type="text" placeholder="vd: thức" />
            </div>
            <div>
              <label style="font-size:12px; color:#6b7280;">Priority</label>
              <input id="so_priority" type="number" value="1" />
            </div>
            <div>
              <label style="font-size:12px; color:#6b7280;">Type</label>
              <select id="so_type" style="width:100%; padding:6px 8px; border:1px solid var(--border); border-radius:8px;">
                <option value="replace">replace</option>
                <option value="protect">protect</option>
              </select>
            </div>
            <div style="display:flex; align-items:flex-end; gap:10px;">
              <div style="display:flex; align-items:center; gap:6px; padding-top:18px;">
                <input id="so_enabled" type="checkbox" checked /> <label for="so_enabled" style="margin:0; font-size:13px;">Enabled</label>
              </div>
            </div>
          </div>
          <div style="margin-top:8px;">
            <label style="font-size:12px; color:#6b7280;">Notes</label>
            <textarea id="so_notes" rows="2" style="width:100%; resize:vertical; padding:6px 8px; border:1px solid var(--border); border-radius:8px;"></textarea>
          </div>
          <div style="margin-top:10px; display:flex; gap:8px;">
            <button id="so_save" class="btn btn-primary" style="min-width:120px;">Lưu</button>
            <button id="so_cancel" class="btn btn-outline-secondary" style="display:none;">Hủy</button>
          </div>
        </div>
        <div id="spellOverrideFilterBar" style="display:none; margin-bottom:8px; gap:8px; align-items:center; flex-wrap:wrap;">
          <input id="so_search" type="text" placeholder="Lọc nhanh token/override" style="flex:1; min-width:180px;" />
          <label style="font-size:12px; display:flex; gap:4px; align-items:center; margin:0;"><input type="checkbox" id="so_show_disabled" /> Hiện cả disabled</label>
        </div>
        <div id="spellOverrideList" style="display:none; max-height:520px; overflow:auto; border:1px solid #e5e5e5; border-radius:6px; padding:6px 6px 4px;"></div>
        <div id="customPhrasesWrap">
          <h3 id="cp_header" style="display:flex; align-items:center; gap:8px;">Custom Phrases</h3>
          <div class="row" id="cp_main_row" style="gap:12px; flex-wrap: wrap; align-items:flex-end;">
            <div style="flex:1 1 200px;">
              <label style="display:block; font-size:12px; color:#6b7280;">Display (tuỳ chọn)</label>
              <input id="cp_display" type="text" placeholder="Hiện thị đẹp (nếu trống dùng Phrase)" />
            </div>
            <div style="width:120px;">
              <label style="display:block; font-size:12px; color:#6b7280;">Priority</label>
              <input id="cp_priority" type="number" value="5"  class="form-control"/>
            </div>
            <div style="flex:1 1 100%; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
              <button id="cp_add" class="btn btn-primary" style="min-width:130px;">Thêm/Update</button>
              <button id="cp_cancel" class="btn btn-outline-secondary" style="display:none;">Hủy</button>
              <button id="cp_refresh" class="btn btn-outline-secondary" title="Tải lại" style="padding:6px 12px;">↻</button>
              <button id="cp_import" class="btn btn-outline-secondary" style="white-space:nowrap;">Import (.txt)</button>
              <button id="cp_import_delete" class="btn btn-outline-danger" style="white-space:nowrap;">Import Xoá (.txt)</button>
              <input id="cp_file" type="file" accept=".txt" style="display:none;" />
              <input id="cp_delete_file" type="file" accept=".txt" style="display:none;" />
            </div>
          </div>
          <div id="cp_filter_row" style="margin-top:10px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <input id="cp_search" type="text" placeholder="Lọc nhanh (server filter)" style="flex:1; min-width:200px;" />
            <button id="cp_clear_filter" class="btn btn-outline-secondary" type="button" title="Xoá filter & tải tất cả" style="padding:6px 10px; line-height:1;">⟳</button>
            <select id="cp_limit" class="form-select" style="width:100px;">
              <option value="20">20</option>
              <option value="50" selected>50</option>
              <option value="100">100</option>
            </select>
            <div style="display:flex; gap:4px; align-items:center; flex-wrap:wrap;">
              <button id="cp_prev" class="btn btn-outline-secondary" disabled>«</button>
              <span id="cp_page_info" class="hint">Trang 1</span>
              <input id="cp_page_jump" type="number" min="1" class="form-control" style="width:72px; padding:4px 6px; font-size:13px;" placeholder="#" title="Nhập số trang & Enter" />
              <button id="cp_next" class="btn btn-outline-secondary" disabled>»</button>
            </div>
          </div>
          <div id="cp_list" style="margin-top:6px; border:1px solid #e5e5e5; border-radius:6px; padding:8px;"></div>
        </div>
      </div>
    </div>

    <!-- Modal: How it works -->
    <div id="howModal" class="ai-modal-backdrop" aria-hidden="true" role="dialog" aria-modal="true">
      <div class="ai-modal" role="document">
        <header>
          <h3>Cách nó hoạt động — Suggest Keywords</h3>
          <button class="close" id="howClose" aria-label="Đóng">×</button>
        </header>
        <div class="content">
          <p><strong>Suggest Keywords</strong> lấy input bạn gõ và trả về danh sách gợi ý được xếp hạng theo độ liên quan + ưu tiên business. Mọi tối ưu đều tuân thủ nguyên tắc <em>zero-diff</em> (bật/tắt flag an toàn không làm đổi thứ tự kết quả cuối).</p>
          <h4>1. Chuẩn hoá & Cache</h4>
          <ul style="margin-bottom:10px;">
            <li>Tách <code>preserve</code> (giữ dấu) & <code>fold</code> (bỏ dấu) để match tiếng Việt không mất dấu hiển thị.</li>
            <li>Tạo cache key: <code>suggest:v&lt;customVersion&gt;:&lt;normalized&gt;:space=&lt;0|1&gt;</code>.</li>
            <li>Nếu hit Redis (≈20s TTL) → trả ngay kèm header thời gian.</li>
          </ul>
          <h4>2. Pipeline (Cache miss)</h4>
          <ol style="margin-bottom:10px; padding-left:20px;">
            <li><strong>Custom phase</strong>: Narrowing nhanh bằng index (ký tự / tiền tố). Có augmentation khi candidate ít.</li>
            <li><strong>Early exit</strong>: Nếu đủ số lượng & cấu hình cho phép (<code>CUSTOM_EARLY_THRESHOLD</code>, mode <code>custom-first</code>).</li>
            <li><strong>Space cuối?</strong> Nếu query kết thúc bằng khoảng trắng ⇒ kích hoạt <em>phrase dict</em> + <em>next-token</em> + branch expansion (giới hạn bởi time budget).</li>
            <li><strong>Chưa space cuối</strong>: Dự đoán phần còn thiếu của token cuối (fallback phrase).</li>
            <li><strong>Embedding (tuỳ chọn)</strong>: Thêm hàng xóm ngữ nghĩa nếu bật.</li>
            <li><strong>Merge → Dedupe → Score → Sort → Trim</strong>.</li>
          </ol>
          <h4>3. Scoring Rút gọn</h4>
          <pre><code>score = normalizer(raw) * weight(type) + priorityBoost(optional)</code></pre>
          <ul style="margin-bottom:10px;">
            <li>Custom có thể thêm <code>priority</code>.</li>
            <li>Match chính xác đầu câu và độ dài hợp lý được bonus nhẹ.</li>
          </ul>
          <h4>4. Nguồn Kết Hợp</h4>
          <ul style="columns:2; -webkit-columns:2; column-gap:26px;">
            <li><strong>Custom</strong>: Cụm do Admin thêm.</li>
            <li><strong>Prefix</strong>: Hoàn tất token hiện tại.</li>
            <li><strong>Phrase Dict</strong>: Cụm PMI cao được mining offline.</li>
            <li><strong>Next-token</strong>: Bigram / trigram dự đoán token kế tiếp.</li>
            <li><strong>Phrase Expansion</strong>: Nối chuỗi next-token thành cụm dài (có giới hạn thời gian + độ sâu).</li>
            <li><strong>Neighbor / Related</strong>: Đồng xuất hiện mạnh.</li>
            <li><strong>Embedding</strong> (optional): Tương tự ngữ nghĩa.</li>
          </ul>
          <h4>5. Hiệu năng</h4>
          <ul style="margin-bottom:10px;">
            <li>Prefix & length narrowing giảm candidate ngay đầu.</li>
            <li>Map reuse + LRU next-token giảm GC & truy vấn lặp.</li>
            <li>Time budget (<code>PHRASE_BUILD_TIME_BUDGET_MS</code>) bảo vệ p95.</li>
            <li>Early exit giữ latency thấp mà không mất tính ổn định kết quả.</li>
          </ul>
          <h4>6. Beautify & Spell (ngoài pipeline này)</h4>
          <p>Nếu tích hợp endpoint <code>/api/spell</code>, hệ thống sửa & làm đẹp dấu trước/hoặc song song suggest. Dấu người dùng đúng sẽ được giữ, sai chuẩn sẽ khôi phục bằng snapshot có trường <code>originalForm</code>.</p>
          <h4>7. Header quan trọng (khi bật timing)</h4>
          <ul style="margin-bottom:10px;">
            <li><code>x-suggest-latency-ms</code>: Tổng thời gian.</li>
            <li><code>x-early-exit-stage</code>: Giai đoạn dừng (nếu có).</li>
            <li><code>x-prof-custom-candidates</code>: Số candidate thô custom.</li>
          </ul>
          <h4>8. Admin</h4>
          <ul style="margin-bottom:10px;">
            <li>Thêm / import / xoá custom phrases.</li>
            <li>Quản lý spell overrides (protect / replace).</li>
            <li>Xem <em>Protect Set</em> để biết token bị chặn sửa.</li>
          </ul>
          <h4>9. Auth</h4>
          <p>Yêu cầu <code>Authorization: Bearer &lt;token&gt;</code>. Ô token tự xử lý nếu bạn không gõ "Bearer".</p>
          <h4>10. Tham khảo thêm</h4>
          <p>Xem đầy đủ kiến trúc, config, flow & playbook trong <a href="readme.html" target="_blank" rel="noopener">README (viewer)</a> hoặc bản tóm tắt kỹ thuật ở <code>HOW_IT_WORKS.md</code>.</p>
          <hr class="my-3"/>
          <div style="display:flex; flex-wrap:wrap; gap:8px;">
            <a href="readme.html" class="btn btn-sm btn-outline-primary" target="_blank" rel="noopener">Mở Full README</a>
            <a href="HOW_IT_WORKS.md" class="btn btn-sm btn-outline-secondary" target="_blank" rel="noopener">HOW_IT_WORKS.md</a>
          </div>
        </div>
      </div>
    </div>
    <!-- Modal: Import guide -->
    <div id="importModal" class="ai-modal-backdrop" aria-hidden="true" role="dialog" aria-modal="true">
      <div class="ai-modal" role="document">
        <header>
          <h3>Hướng dẫn Import Custom Phrases</h3>
          <button class="close" id="importClose" aria-label="Đóng">×</button>
        </header>
        <div class="content">
          <p>File phải là <strong>.txt</strong>. Mỗi dòng trong file tương ứng <strong>1 custom phrase</strong>.</p>
          <ul>
            <li>Các dòng trống sẽ bị bỏ qua tự động.</li>
            <li>Không cần viết hoa đầu câu hay dấu ở cuối.</li>
            <li>Hãy chọn trước <strong>Priority</strong> (ô Priority ở form). Tất cả phrase trong file sẽ dùng chung priority đó.</li>
            <li>Nếu phrase đã tồn tại: backend sẽ <strong>merge</strong> (giữ display cũ trừ khi bạn nhập display mới ở form; priority sẽ lấy giá trị cao hơn giữa cũ và mới).</li>
          </ul>
          <p>Sau khi bấm <em>“Đã hiểu, chọn file…”</em> hệ thống sẽ mở hộp thoại để bạn chọn file .txt. Nhấn <em>Back</em> hoặc click ra ngoài để huỷ.</p>
          <div class="d-flex flex-wrap gap-2 mt-3">
            <button id="importBack" class="btn btn-outline-secondary" type="button">Back</button>
            <button id="importOk" class="btn btn-primary" type="button">Đã hiểu, chọn file…</button>
          </div>
        </div>
      </div>
    </div>
  <!-- Modal: Import Delete guide (flexible match) -->
    <div id="importDelModal" class="ai-modal-backdrop" aria-hidden="true" role="dialog" aria-modal="true">
      <div class="ai-modal" role="document">
        <header>
          <h3>Import danh sách cần XÓA</h3>
          <button class="close" id="importDelClose" aria-label="Đóng">×</button>
        </header>
        <div class="content">
          <p>File phải là <strong>.txt</strong>. Mỗi dòng = 1 cụm cần xoá.</p>
          <ul>
            <li>Dòng trống sẽ bỏ qua.</li>
            <li>Hệ thống sẽ tìm theo <code>phrase</code> (exact, case-insensitive & bỏ dấu) trước; nếu không thấy thử match <code>display</code>.</li>
            <li>Nếu nhiều kết quả: chọn kết quả ưu tiên match phrase exact, sau đó tới display, cuối cùng lấy dòng đầu.</li>
            <li>Nếu không tìm được gì: ghi dòng đó vào danh sách <em>Not Found</em>.</li>
          </ul>
          <p>Sau khi bấm <em>“Đã hiểu, chọn file…”</em> chọn file .txt. Hệ thống xoá theo batch & báo thống kê.</p>
          <div class="d-flex flex-wrap gap-2 mt-3">
            <button id="importDelBack" class="btn btn-outline-secondary" type="button">Back</button>
            <button id="importDelOk" class="btn btn-danger" type="button">Đã hiểu, chọn file…</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const $ = (sel) => document.querySelector(sel);
  const createEl = (tag, props={}) => Object.assign(document.createElement(tag), props);
    const apiBase = $('#apiBase');
    const token = $('#token');
    const q = $('#q');
  const list = $('#list');
  const limitSel = $('#limit');
  const resultsWrap = $('#resultsWrap');
  const results = $('#results');
  const pageNum = $('#pageNum');
  const prevBtn = $('#prevBtn');
  const nextBtn = $('#nextBtn');
  const queryEcho = $('#queryEcho');
  const didYouMeanWrap = $('#didYouMeanWrap');
  const endpointPreview = document.getElementById('endpointPreview');
  const showTypeScore = document.getElementById('showTypeScore');
  const autoTrackClick = document.getElementById('autoTrackClick');
  const btnRebuildVectors = document.getElementById('btnRebuildVectors');
  const btnRebuildDict = document.getElementById('btnRebuildDict');
  const btnSearchNow = document.getElementById('btnSearchNow');
  const btnStats1d = document.getElementById('btnStats1d');
  const latencyInfo = document.getElementById('latencyInfo');
  // Removed cp_phrase: display is authoritative
  const cp_display = document.getElementById('cp_display');
  const cp_priority = document.getElementById('cp_priority');
  const cp_add = document.getElementById('cp_add');
  const cp_cancel = document.getElementById('cp_cancel');
  const cp_refresh = document.getElementById('cp_refresh');
  const cp_list = document.getElementById('cp_list');
  const cp_search = document.getElementById('cp_search');
  const cp_clear_filter = document.getElementById('cp_clear_filter');
  const cp_limit = document.getElementById('cp_limit');
  const cp_prev = document.getElementById('cp_prev');
  const cp_next = document.getElementById('cp_next');
  const cp_page_info = document.getElementById('cp_page_info');
  const cp_page_jump = document.getElementById('cp_page_jump');
  const cp_import = document.getElementById('cp_import');
  const cp_file = document.getElementById('cp_file');
  const cp_import_delete = document.getElementById('cp_import_delete');
  const cp_delete_file = document.getElementById('cp_delete_file');
  const adminSection = document.getElementById('adminSection');
  const btnToggleAdmin = document.getElementById('btnToggleAdmin');
  const howItWorksBtn = document.getElementById('howItWorksBtn');
  const howModal = document.getElementById('howModal');
  const howClose = document.getElementById('howClose');
  const btnDarkMode = document.getElementById('btnDarkMode');
  // Import modal elements
  const importModal = document.getElementById('importModal');
  const importClose = document.getElementById('importClose');
  const importOk = document.getElementById('importOk');
  const importBack = document.getElementById('importBack');
  const importDelModal = document.getElementById('importDelModal');
  const importDelClose = document.getElementById('importDelClose');
  const importDelOk = document.getElementById('importDelOk');
  const importDelBack = document.getElementById('importDelBack');

  // Spell override admin elements
  const tabCustomPhrases = document.getElementById('tabCustomPhrases');
  const tabSpellOverrides = document.getElementById('tabSpellOverrides');
  const so_reload = document.getElementById('so_reload');
  const so_new = document.getElementById('so_new');
  const so_token = document.getElementById('so_token');
  const so_override = document.getElementById('so_override');
  const so_priority = document.getElementById('so_priority');
  const so_type = document.getElementById('so_type');
  const btnProtectSet = document.getElementById('btnProtectSet');
  const protectSetPanel = document.getElementById('protectSetPanel');
  const protectSetList = document.getElementById('protectSetList');
  const protectSetStats = document.getElementById('protectSetStats');
  const protectSetClose = document.getElementById('protectSetClose');
  const protectSetFilter = document.getElementById('protectSetFilter');
  const protectSetRefresh = document.getElementById('protectSetRefresh');
  let protectSetCache = [];

  async function fetchProtectSet(showToast=true) {
    const base = apiBase.value.trim();
    const url = base.replace(/\/$/,'') + '/api/search/protect_tokens';
    const t0 = performance.now();
    try {
      const resp = await fetch(url, { headers: buildAuthHeaders() });
      const data = await resp.json();
      if (!data?.success) throw new Error(data?.message || 'Fetch failed');
      protectSetCache = data.data?.tokens || [];
      const total = data.data?.total || protectSetCache.length;
      const topCount = data.data?.top_count || 0;
      const overrideCount = data.data?.override_protect_count || 0;
      protectSetStats.textContent = `(tổng ${total} • top ${topCount} • override ${overrideCount})`;
      renderProtectSet();
      if (showToast) showToastMsg('Protect set loaded');
      const dt = performance.now() - t0;
      latencyInfo.textContent = dt.toFixed(0) + 'ms';
    } catch (e) {
      showToastMsg('Error tải protect set: ' + e.message, 'danger');
    }
  }

  function renderProtectSet() {
    const q = (protectSetFilter.value||'').trim().toLowerCase();
    protectSetList.innerHTML = '';
    let list = protectSetCache;
    if (q) list = list.filter(t => t.includes(q));
    if (!list.length) {
      protectSetList.innerHTML = '<div style="grid-column:1/-1; font-size:13px; color:#6b7280;">(Không có kết quả)</div>';
      return;
    }
    for (const tok of list) {
      const chip = createEl('div', { className:'ps-chip', textContent: tok });
      chip.style.padding = '4px 6px';
      chip.style.border = '1px solid var(--border)';
      chip.style.borderRadius = '8px';
      chip.style.fontSize = '12px';
      chip.style.background = '#fff';
      chip.style.whiteSpace = 'nowrap';
      protectSetList.appendChild(chip);
    }
  }

  if (btnProtectSet) {
    btnProtectSet.addEventListener('click', () => {
      const showing = protectSetPanel.style.display !== 'none';
      if (showing) {
        protectSetPanel.style.display = 'none';
      } else {
        protectSetPanel.style.display = 'block';
        fetchProtectSet(false);
      }
    });
  }
  if (protectSetClose) protectSetClose.addEventListener('click', () => { protectSetPanel.style.display='none'; });
  if (protectSetFilter) protectSetFilter.addEventListener('input', () => renderProtectSet());
  if (protectSetRefresh) protectSetRefresh.addEventListener('click', () => fetchProtectSet());
  const so_enabled = document.getElementById('so_enabled');
  const so_notes = document.getElementById('so_notes');
  const so_save = document.getElementById('so_save');
  const so_cancel = document.getElementById('so_cancel');
  const so_search = document.getElementById('so_search');
  const so_show_disabled = document.getElementById('so_show_disabled');
  const so_list = document.getElementById('spellOverrideList');
  const so_form_wrap = document.getElementById('spellOverrideFormWrap');
  const so_actions = document.getElementById('spellOverrideActions');
  const so_filter_bar = document.getElementById('spellOverrideFilterBar');
  const cp_header = document.getElementById('cp_header');

  let soEditingToken = null;
  let soCache = [];
  // Spell correction state (used to highlight using corrected query when two-pass spell correction applied)
  let lastCorrectedQuery = null;
  let lastSpellChanged = false;

  function switchAdminTab(tab) {
    const isSO = tab === 'spell';
    // Buttons styling
    if (tabCustomPhrases) {
      tabCustomPhrases.classList.toggle('btn-primary', !isSO);
      tabCustomPhrases.classList.toggle('btn-outline-secondary', isSO);
    }
    if (tabSpellOverrides) {
      tabSpellOverrides.classList.toggle('btn-primary', isSO);
      tabSpellOverrides.classList.toggle('btn-outline-secondary', !isSO);
    }
    // Simplified: wrap all custom phrase UI in #customPhrasesWrap
    const cpWrap = document.getElementById('customPhrasesWrap');
    if (cpWrap) cpWrap.style.display = isSO ? 'none' : 'block';
    // Spell override controls
    so_actions.style.display = isSO ? 'flex' : 'none';
    so_form_wrap.style.display = (isSO && soEditingToken) ? 'block' : 'none';
    so_filter_bar.style.display = isSO ? 'flex' : 'none';
    so_list.style.display = isSO ? 'block' : 'none';
    if (!isSO && cp_list && !cp_list.innerHTML.trim()) { try { loadCustomPhrases(); } catch(_) {} }
    if (isSO) {
      loadSpellOverrides().catch(e => showToast('Lỗi tải overrides: ' + String(e), { variant:'danger', title:'Lỗi'}));
    } else {
      // ensure custom phrases visible
      loadCustomPhrases().catch(()=>{});
    }
  }

  tabCustomPhrases?.addEventListener('click', () => switchAdminTab('custom'));
  tabSpellOverrides?.addEventListener('click', () => switchAdminTab('spell'));

  async function fetchSpellOverrides(showDisabled) {
    const base = apiBase.value.replace(/\/$/, '');
    const params = new URLSearchParams();
    if (!showDisabled) params.set('enabled', '1');
    const url = `${base}/api/search/spell_overrides?${params.toString()}`;
  const headers = {};
    const tk = token.value.trim();
    if (tk) headers['Authorization'] = tk.startsWith('Bearer ') ? tk : `Bearer ${tk}`;
    const res = await fetch(url, { headers });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const js = await res.json();
    return js?.data || [];
  }

  function renderSpellOverrides() {
    const filter = (so_search?.value || '').trim().toLowerCase();
    so_list.innerHTML = '';
    const rows = soCache.filter(r => {
      if (!filter) return true;
      return String(r.token).includes(filter) || String(r.override).includes(filter) || String(r.notes||'').toLowerCase().includes(filter);
    });
    if (!rows.length) { so_list.innerHTML = '<div class="hint">Chưa có override</div>'; return; }
    rows.forEach(r => {
      const row = document.createElement('div');
      row.style.display = 'flex';
      row.style.alignItems = 'center';
      row.style.justifyContent = 'space-between';
      row.style.borderBottom = '1px solid #eee';
      row.style.padding = '6px 6px';
      const typeBadgeColor = ({
        replace: '#6366f1',
        protect: '#059669',
        block: '#dc2626',
        expand: '#d97706',
        alias: '#7c3aed'
      })[r.type || 'replace'];
      row.innerHTML = `<div style="flex:1; min-width:0;">
          <strong>${escapeHtml(r.token)}</strong> → <span style="color:var(--purple-pain); font-weight:600;">${escapeHtml(r.override)}</span>
          <span style="display:inline-block; margin-left:4px; padding:2px 6px; font-size:11px; border-radius:999px; background:${typeBadgeColor||'#6366f1'}; color:#fff; text-transform:uppercase; letter-spacing:.5px;">${escapeHtml(r.type || 'replace')}</span>
          <div class="hint" style="margin-top:2px;">prio ${r.priority} • ${r.enabled? 'enabled':'disabled'} ${r.notes? ('• '+escapeHtml(r.notes)) : ''}</div>
        </div>`;
      const act = document.createElement('div');
      act.style.display = 'flex';
      act.style.gap = '6px';
      const editBtn = document.createElement('button'); editBtn.textContent = 'Sửa'; editBtn.className='btn btn-sm btn-outline-secondary';
      editBtn.addEventListener('click', () => {
        soEditingToken = r.token;
        so_token.value = r.token;
        so_override.value = r.override;
        so_priority.value = r.priority;
        if (so_type) so_type.value = r.type || 'replace';
        so_enabled.checked = !!r.enabled;
        so_notes.value = r.notes || '';
        so_form_wrap.style.display = 'block';
        so_cancel.style.display = 'inline-block';
      });
      const enBtn = document.createElement('button'); enBtn.textContent = r.enabled? 'Disable':'Enable'; enBtn.className='btn btn-sm btn-outline-secondary';
      enBtn.addEventListener('click', () => toggleEnableOverride(r));
      const delBtn = document.createElement('button'); delBtn.textContent = 'Xóa'; delBtn.className='btn btn-sm btn-outline-danger';
      delBtn.addEventListener('click', () => deleteOverride(r));
      act.appendChild(editBtn); act.appendChild(enBtn); act.appendChild(delBtn);
      row.appendChild(act);
      so_list.appendChild(row);
    });
  }

  async function loadSpellOverrides() {
    so_list.innerHTML = '<div class="hint">Loading...</div>';
    soCache = await fetchSpellOverrides(!!so_show_disabled?.checked);
    renderSpellOverrides();
  }

  async function saveSpellOverride() {
    const tokenVal = (so_token.value || '').trim();
    const overrideVal = (so_override.value || '').trim();
    if (!tokenVal) return showToast('Nhập token', { variant:'warning', title:'Thiếu'});
    if (!overrideVal) return showToast('Nhập override', { variant:'warning', title:'Thiếu'});
    const base = apiBase.value.replace(/\/$/, '');
    const url = `${base}/api/search/spell_overrides`;
  const headers = { 'Content-Type':'application/json' };
    const tk = token.value.trim(); if (tk) headers['Authorization'] = tk.startsWith('Bearer ') ? tk : `Bearer ${tk}`;
    const body = { token: tokenVal, override: overrideVal, type: so_type ? so_type.value : 'replace', enabled: !!so_enabled.checked, priority: parseFloat(so_priority.value)||1, notes: (so_notes.value||'').trim() };
    try {
      const res = await fetch(url, { method: 'POST', headers, body: JSON.stringify(body) });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const js = await res.json();
      showToast(js?.message || 'Đã lưu', { variant:'success', title:'Spell Override'});
      soEditingToken = null;
      so_token.value = '';
      so_override.value = '';
      so_priority.value = '1';
      if (so_type) so_type.value = 'replace';
      so_enabled.checked = true;
      so_notes.value = '';
      so_cancel.style.display = 'none';
      so_form_wrap.style.display = 'none';
      await loadSpellOverrides();
    } catch (e) {
      showToast('Lỗi lưu: ' + String(e), { variant:'danger', title:'Lỗi'});
    }
  }

  async function toggleEnableOverride(row) {
    const base = apiBase.value.replace(/\/$/, '');
  const headers = {};
    const tk = token.value.trim(); if (tk) headers['Authorization'] = tk.startsWith('Bearer ') ? tk : `Bearer ${tk}`;
    const path = `/api/search/spell_overrides/${encodeURIComponent(row.token)}/${row.enabled? 'disable':'enable'}`;
    try {
      const res = await fetch(base + path, { method: 'PATCH', headers });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      showToast(row.enabled? 'Đã disable':'Đã enable', { variant:'success', title:'Spell Override'});
      await loadSpellOverrides();
    } catch (e) { showToast('Lỗi: ' + String(e), { variant:'danger', title:'Lỗi'}); }
  }

  async function deleteOverride(row) {
    if (!confirm(`Xóa override token "${row.token}"?`)) return;
    const base = apiBase.value.replace(/\/$/, '');
  const headers = { 'Content-Type':'application/json' };
    const tk = token.value.trim(); if (tk) headers['Authorization'] = tk.startsWith('Bearer ') ? tk : `Bearer ${tk}`;
    try {
      // body.id
      let res = await fetch(`${base}/api/search/spell_overrides`, { method:'DELETE', headers, body: JSON.stringify({ id: row.token }) });
      if (!res.ok) {
        // fallback path
        res = await fetch(`${base}/api/search/spell_overrides/${encodeURIComponent(row.token)}`, { method:'DELETE', headers });
      }
      if (!res.ok) throw new Error('HTTP ' + res.status);
      showToast('Đã xoá', { variant:'success', title:'Spell Override'});
      await loadSpellOverrides();
    } catch (e) { showToast('Xóa lỗi: ' + String(e), { variant:'danger', title:'Lỗi'}); }
  }

  so_new?.addEventListener('click', () => {
    soEditingToken = null;
    so_token.value = '';
    so_override.value = '';
    so_priority.value = '1';
    so_enabled.checked = true;
    so_notes.value = '';
    so_form_wrap.style.display = 'block';
    so_cancel.style.display = 'none';
  });
  so_save?.addEventListener('click', saveSpellOverride);
  so_cancel?.addEventListener('click', () => { soEditingToken = null; so_form_wrap.style.display='none'; });
  so_reload?.addEventListener('click', async () => {
    const base = apiBase.value.replace(/\/$/, '');
  const headers = {};
    const tk = token.value.trim(); if (tk) headers['Authorization'] = tk.startsWith('Bearer ') ? tk : `Bearer ${tk}`;
    try {
      // Backend expects POST /api/search/spell_overrides/reload
      const res = await fetch(`${base}/api/search/spell_overrides/reload`, { method:'get', headers });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      showToast('Reload cache OK', { variant:'success', title:'Spell Override'});
      await loadSpellOverrides();
    } catch (e) { showToast('Reload lỗi: ' + String(e), { variant:'danger', title:'Lỗi'}); }
  });
  let soSearchTimer; so_search?.addEventListener('input', () => { clearTimeout(soSearchTimer); soSearchTimer=setTimeout(renderSpellOverrides, 250); });
  so_show_disabled?.addEventListener('change', () => loadSpellOverrides().catch(()=>{}));

  // SessionStorage flags (per session) to skip guide modals after user acknowledged
  const SS_IMPORT_ACK_KEY = 'cp_import_ack_v1';
  const SS_IMPORT_DEL_ACK_KEY = 'cp_import_del_ack_v1';
  const hasImportAck = () => sessionStorage.getItem(SS_IMPORT_ACK_KEY) === '1';
  const hasImportDelAck = () => sessionStorage.getItem(SS_IMPORT_DEL_ACK_KEY) === '1';
  const setImportAck = () => sessionStorage.setItem(SS_IMPORT_ACK_KEY, '1');
  const setImportDelAck = () => sessionStorage.setItem(SS_IMPORT_DEL_ACK_KEY, '1');

    let timer;
    let activeIndex = -1;
  let currentPage = 1;

      // Modal helpers
      function openHowModal() {
        if (!howModal) return;
        howModal.style.display = 'flex';
        howModal.setAttribute('aria-hidden', 'false');
      }
      function closeHowModal() {
        if (!howModal) return;
        howModal.style.display = 'none';
        howModal.setAttribute('aria-hidden', 'true');
      }
      howItWorksBtn?.addEventListener('click', openHowModal);
      howClose?.addEventListener('click', closeHowModal);
      howModal?.addEventListener('click', (e) => { if (e.target === howModal) closeHowModal(); });
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeHowModal(); });

      // Import modal helpers
      function openImportModal() {
        if (!importModal) return;
        importModal.style.display = 'flex';
        importModal.setAttribute('aria-hidden', 'false');
      }
      function closeImportModal() {
        if (!importModal) return;
        importModal.style.display = 'none';
        importModal.setAttribute('aria-hidden', 'true');
      }
      importClose?.addEventListener('click', closeImportModal);
      importBack?.addEventListener('click', closeImportModal);
      importModal?.addEventListener('click', (e) => { if (e.target === importModal) closeImportModal(); });
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeImportModal(); });
      importOk?.addEventListener('click', () => {
        setImportAck();
        closeImportModal();
        if (cp_file) {
          cp_file.value = '';
          setTimeout(() => cp_file.click(), 30);
        }
      });

      // Import DELETE modal helpers
      function openImportDelModal() {
        if (!importDelModal) return;
        importDelModal.style.display = 'flex';
        importDelModal.setAttribute('aria-hidden', 'false');
      }
      function closeImportDelModal() {
        if (!importDelModal) return;
        importDelModal.style.display = 'none';
        importDelModal.setAttribute('aria-hidden', 'true');
      }
      importDelClose?.addEventListener('click', closeImportDelModal);
      importDelBack?.addEventListener('click', closeImportDelModal);
      importDelModal?.addEventListener('click', (e) => { if (e.target === importDelModal) closeImportDelModal(); });
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeImportDelModal(); });
      importDelOk?.addEventListener('click', () => {
        setImportDelAck();
        closeImportDelModal();
        if (cp_delete_file) {
          cp_delete_file.value = '';
          setTimeout(() => cp_delete_file.click(), 30);
        }
      });

      // Modal handlers
      let cpPage = 1;
      let cpTotalPages = 1;
      function updateCpPageInfo(total, limit) {
        cp_page_info.textContent = `Trang ${cpPage}/${cpTotalPages}`;
        if (cp_page_jump) {
          cp_page_jump.setAttribute('max', String(Math.max(1, cpTotalPages)));
          cp_page_jump.value = String(cpPage);
        }
        cp_prev.disabled = cpPage <= 1;
        cp_next.disabled = cpPage >= cpTotalPages;
      }

      function jumpToPage(raw) {
        if (!raw) return;
        let n = parseInt(raw, 10);
        if (isNaN(n)) return;
        if (n < 1) n = 1;
        if (n > cpTotalPages) n = cpTotalPages;
        if (n === cpPage) return; // no change
        cpPage = n;
  loadCustomPhrases().catch(e => showToast('Lỗi tải danh sách: ' + String(e), { variant: 'danger', title: 'Lỗi' }));
      }

      cp_page_jump?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          jumpToPage(e.target && e.target.value);
        }
      });
      cp_page_jump?.addEventListener('blur', (e) => {
        jumpToPage(e.target && e.target.value);
      });

      // Track editing id (moved up to avoid TDZ when loadCustomPhrases() runs early)
      let editingId = null;
          let lastDeletedPhrase = null; // store last deleted for undo
          let lastDeleteUndoTimer = null;

          // Bootstrap toast container ensure
          if (!document.getElementById('toastContainer')) {
            const tc = document.createElement('div');
            tc.id = 'toastContainer';
            tc.className = 'toast-container';
            tc.setAttribute('aria-live','polite');
            tc.setAttribute('aria-atomic','true');
            document.body.appendChild(tc);
          }
          // New Bootstrap based toast utility
          function showToast(msg, { actions = [], duration = 4000, title = '', variant = 'info' } = {}) {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            const id = 'toast_' + Date.now() + '_' + Math.random().toString(36).slice(2);
            const toastEl = document.createElement('div');
            toastEl.className = 'toast';
            toastEl.role = 'alert';
            toastEl.ariaLive = 'assertive';
            toastEl.ariaAtomic = 'true';
            toastEl.id = id;
            if (variant && variant !== 'info') {
              if (['success','danger','warning','primary','secondary'].includes(variant)) {
                toastEl.classList.add('bg-' + variant, variant === 'warning' || variant === 'secondary' ? 'text-dark' : 'text-white');
              }
            }
            let header = '';
            if (title) {
              header = `<div class="toast-header"><strong class="me-auto">${title}</strong><button type="button" class="btn-close ms-2 mb-1" data-bs-dismiss="toast" aria-label="Close"></button></div>`;
            }
            const body = document.createElement('div');
            body.className = 'toast-body';
            body.innerHTML = `<div>${msg}</div>`;
            if (actions.length) {
              const actDiv = document.createElement('div');
              actDiv.className = 'toast-actions';
              actions.forEach((a,i)=>{
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'btn btn-sm btn-' + (a.variant || 'outline-secondary');
                btn.textContent = a.label;
                btn.addEventListener('click', () => { try { a.onClick && a.onClick(); } finally { toast.hide(); } });
                actDiv.appendChild(btn);
              });
              body.appendChild(actDiv);
            }
            toastEl.innerHTML = header;
            toastEl.appendChild(body);
            container.appendChild(toastEl);
            const toast = new bootstrap.Toast(toastEl, { delay: duration, autohide: !actions.length });
            toast.show();
            toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
            return toast;
          }

          function renderSkeleton(count = 6) {
            const frag = document.createDocumentFragment();
            for (let i=0;i<count;i++) {
              const row = document.createElement('div');
              row.className = 'sk-row';
              row.innerHTML = `<div class='sk-left'>
                 <div class='sk-line w60'></div>
                 <div class='sk-line w30'></div>
              </div>
              <div style='display:flex; gap:6px;'>
                 <div class='sk-line w40' style='width:50px;'></div>
                 <div class='sk-line w30' style='width:40px;'></div>
              </div>`;
              frag.appendChild(row);
            }
            cp_list.innerHTML='';
            cp_list.appendChild(frag);
          }

          function highlightAdminDisplay(text, filter) {
            if (!filter) return escapeHtml(text);
            // Normalize both in accent-insensitive way, map match segments
            const fold = s => (s||'').toLowerCase()
              .replace(/đ/g,'d').replace(/Đ/g,'d')
              .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
              .replace(/[^a-z0-9\s]/g,' ')
              .replace(/\s+/g,' ').trim();
            const normFilterTokens = [...new Set(fold(filter).split(' ').filter(Boolean))].sort((a,b)=>b.length-a.length);
            if (!normFilterTokens.length) return escapeHtml(text);
            // Build mapping similar to suggestion highlight but simpler
            const rebuilt = [];
            const map = [];
            for (let i=0;i<text.length;i++) {
              let base = text[i].normalize('NFD').replace(/[\u0300-\u036f]/g,'');
              for (const c of base) {
                map.push(i);
                rebuilt.push(c.toLowerCase()==='đ'?'d':c.toLowerCase());
              }
            }
            const rebuiltStr = rebuilt.join('');
            const mark = new Array(rebuiltStr.length).fill(false);
            for (const tok of normFilterTokens) {
              if (!tok) continue;
              let start=0; while(start < rebuiltStr.length){
                const idx = rebuiltStr.indexOf(tok,start);
                if (idx===-1) break;
                const leftOk = idx===0 || /[^a-z0-9]/.test(rebuiltStr[idx-1]);
                const rightPos = idx + tok.length;
                const rightOk = rightPos===rebuiltStr.length || /[^a-z0-9]/.test(rebuiltStr[rightPos]);
                if (leftOk && rightOk) { for(let k=idx;k<idx+tok.length;k++) mark[k]=true; }
                start = idx + tok.length;
              }
            }
            let cur = mark[0]||false; let segStart=0; const segs=[];
            for (let pos=1; pos<=mark.length; pos++) {
              if (pos===mark.length || mark[pos]!==cur) {
                const oStart = map[segStart];
                const oEnd = map[pos-1]+1;
                const raw = text.slice(oStart,oEnd);
                segs.push(cur? `<span class="cp-hit">${escapeHtml(raw)}</span>` : escapeHtml(raw));
                segStart=pos; cur=mark[pos];
              }
            }
            return segs.join('');
          }

      async function loadCustomPhrases(opts = {}) {
        if (opts.resetPage) cpPage = 1;
        const base = apiBase.value.replace(/\/$/, '');
        const limit = parseInt(cp_limit.value, 10) || 50;
        const qFilter = (cp_search.value || '').trim();
        renderSkeleton(Math.min(6, limit));
        const params = new URLSearchParams({ limit: String(limit), page: String(cpPage) });
        if (qFilter) params.set('q', qFilter);
        const url = `${base}/api/search/custom_phrases?${params.toString()}`;
        const headers = {};
        const tk = token.value.trim();
        if (tk) headers['Authorization'] = tk.startsWith('Bearer ') ? tk : `Bearer ${tk}`;
        const res = await fetch(url, { headers });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const json = await res.json();
        const rows = json?.data || [];
        const meta = json?.pagination || {};
        cpTotalPages = meta.pages || 1;
        cp_list.innerHTML = '';
        rows.forEach((r) => {
          const rid = r?._id || r?.id || r?._doc?._id || r?.pk || '';
          const div = document.createElement('div');
          div.style.display = 'flex';
          div.style.justifyContent = 'space-between';
          div.style.alignItems = 'center';
          div.style.padding = '6px 8px';
          div.style.borderBottom = '1px solid #eee';
          const title = document.createElement('div');
          const idText = escapeHtml(String(rid || ''));
          const disp = r.display || r.phrase;
          const highlighted = highlightAdminDisplay(String(disp||''), qFilter);
          title.innerHTML = `<strong>${highlighted}</strong><br/><span class="hint">${escapeHtml((r.tokens || []).join(' '))} • priority ${r.priority} • id ${idText}</span>`;
          const actions = document.createElement('div');
          actions.style.display = 'flex';
          actions.style.gap = '8px';
          const editBtn = document.createElement('button');
          editBtn.textContent = 'Sửa';
          editBtn.addEventListener('click', () => {
            editingId = rid;
            // phrase field removed; nothing to populate here
            cp_display.value = r.display || '';
            cp_priority.value = (r.priority ?? 1);
            cp_add.textContent = 'Lưu (Update)';
            cp_cancel.style.display = 'inline-block';
            if (!showAdmin) btnToggleAdmin.click();
          });
          const delBtn = document.createElement('button');
          delBtn.textContent = 'Xoá';
          delBtn.addEventListener('click', async () => {
            if (!rid) return showToast('Không tìm thấy id để xoá', { variant: 'warning', title: 'Cảnh báo' });
            if (!confirm('Xoá mục này?')) return;
            try {
              // store for undo
              lastDeletedPhrase = { id: rid, record: r };
              const ok = await deleteCustomPhrase(rid);
              if (!ok) return;
              await loadCustomPhrases();
              if (lastDeleteUndoTimer) clearTimeout(lastDeleteUndoTimer);
              showToast('Đã xoá 1 phrase', { actions: [ { label: 'Hoàn tác', onClick: async () => {
                  if (!lastDeletedPhrase) return;
                  try {
                    const baseUrl = apiBase.value.replace(/\/$/, '');
                    const headers2 = { 'Content-Type':'application/json' };
                    const tk2 = token.value.trim();
                    if (tk2) headers2['Authorization'] = tk2.startsWith('Bearer ')? tk2 : `Bearer ${tk2}`;
                    // Recreate using POST (ignore original id to let backend assign new if needed)
                    const body = JSON.stringify({ display: lastDeletedPhrase.record.display, priority: lastDeletedPhrase.record.priority });
                    const resp = await fetch(`${baseUrl}/api/search/custom_phrases`, { method:'POST', headers: headers2, body });
                    if (resp.ok) {
                      await loadCustomPhrases();
                      showToast('Đã hoàn tác xoá', { duration: 2000 });
                    } else {
                      const t = await resp.text();
                      showToast('Hoàn tác thất bại: '+ resp.status + ' ' + t, { variant: 'danger', title: 'Lỗi' });
                    }
                  } catch(err) { showToast('Lỗi: ' + String(err), { variant: 'danger', title: 'Lỗi' }); }
                }} ], duration: 6000 });
            } catch(e) { showToast('Lỗi: ' + String(e), { variant: 'danger', title: 'Lỗi' }); }
          });
          actions.appendChild(editBtn);
          actions.appendChild(delBtn);
          div.appendChild(title);
            div.appendChild(actions);
          cp_list.appendChild(div);
        });
        if (!rows.length) cp_list.innerHTML = '<div class="hint">Chưa có phrase nào.</div>';
        updateCpPageInfo();
      }

    function setList(items) {
      list.innerHTML = '';
      if (!items || items.length === 0) {
        list.style.display = 'none';
        return;
      }
  // Start with no active item; only hover will set
  if (activeIndex >= items.length) activeIndex = -1;
      items.forEach((it, idx) => {
        const div = document.createElement('div');
        div.className = 'item' + (idx === activeIndex ? ' active' : '');
        const badge = showTypeScore.checked ? `<span class="badge">${escapeHtml(it.type || '')}${typeof it.score !== 'undefined' ? `:${String(it.score)}` : ''}</span>` : '';
        div.innerHTML = `${badge}<span>${renderHighlight(it)}</span>`;
        div.addEventListener('mouseenter', () => {
          // Hover moves active highlight
          activeIndex = idx;
          Array.from(list.children).forEach((c,i)=> c.classList.toggle('active', i===activeIndex));
        });
        div.addEventListener('mousedown', (e) => {
          e.preventDefault();
          const beforeQ = q.value;
          q.value = it.full || it.text;
          if (autoTrackClick.checked) {
            trackSuggestClick(beforeQ, it).catch(err => console.warn('track click error', err));
          }
          list.style.display = 'none';
        });
        list.appendChild(div);
      });
      list.style.display = 'block';
      if (activeIndex >= 0 && list.children[activeIndex]) {
        list.children[activeIndex].scrollIntoView({ block: 'nearest' });
      }
    }

    function escapeHtml(str) {
      return String(str || '').replace(/[&<>"]+/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]));
    }

    let lastSuggestLatency = null;
    async function fetchSuggest(v, signal) {
      const base = apiBase.value.replace(/\/$/, '');
      const url = `${base}/api/search/suggest_keywords?query=${encodeURIComponent(v)}`;
      const headers = {};
      const tk = token.value.trim();
      if (tk) headers['Authorization'] = tk.startsWith('Bearer ') ? tk : `Bearer ${tk}`;
      const res = await fetch(url, { headers, signal }).catch(e => {
        if (e.name === 'AbortError') return { ok:false, aborted:true };
        throw e;
      });
      if (res.aborted) return [];
      if (!res.ok) throw new Error('HTTP ' + res.status);
      lastSuggestLatency = res.headers.get('x-suggest-latency-ms');
      latencyInfo.textContent = lastSuggestLatency ? `Latency: ${lastSuggestLatency} ms` : '';
      const json = await res.json();
      // Capture backend spell meta for highlight
      try {
        const ms = json?.meta?.spell;
        if (ms && typeof ms === 'object') {
          const orig = ms.original || '';
          const corr = ms.corrected || '';
          lastSpellChanged = !!ms.changed && !!corr && corr !== orig;
          lastCorrectedQuery = lastSpellChanged ? corr : null;
        } else {
          lastSpellChanged = false;
          lastCorrectedQuery = null;
        }
      } catch { lastSpellChanged = false; lastCorrectedQuery = null; }
      return json?.data || [];
    }

    // Removed secondary custom phrases fetch to simplify autocomplete (single suggest API only)

    let lastInputSeq = 0;
    let currentSuggestAbort = null;
    function onInput() {
      clearTimeout(timer);
      const v = q.value; // không trim để giữ khoảng trắng cuối
      lastInputSeq++;
      const seq = lastInputSeq;
      // Abort previous in-flight
      if (currentSuggestAbort) {
        try { currentSuggestAbort.abort(); } catch {}
      }
      // Cập nhật endpoint preview ngay lập tức để realtime
      updateEndpoint();
      if (!v || !v.replace(/\s+/g, '')) {
        // Clear immediately & hide list to tránh giữ ký tự đầu
        currentItemsCache = [];
        setList([]);
        list.style.display = 'none';
        lastCorrectedQuery = null; lastSpellChanged = false;
        // Ẩn luôn kết quả cũ nếu user xoá sạch
        if (resultsWrap) {
          resultsWrap.style.display = 'none';
          results.innerHTML = '';
          if (queryEcho) queryEcho.textContent='';
          pageNum.textContent = '1';
        }
        // Admin list refresh ngay khi clear (không đợi debounce)
        if (showAdmin && cp_search) {
          cp_search.value = '';
          loadCustomPhrases({ resetPage: true }).catch(()=>{});
        }
        return;
      }
      timer = setTimeout(async () => {
        const qNow = q.value;
        if (seq !== lastInputSeq) return;
        if (!qNow || !qNow.replace(/\s+/g,'')) { setList([]); list.style.display='none'; return; }
        const ac = new AbortController();
        currentSuggestAbort = ac;
        try {
          const items = await fetchSuggest(qNow, ac.signal);
          if (seq !== lastInputSeq) return;
          activeIndex = items && items.length ? 0 : -1;
          setList(items || []);
          if (!items || !items.length) list.style.display='none';
        } catch(e){
          if (e?.name !== 'AbortError') console.warn('suggest fetch error', e);
        }
      }, 80); // giảm debounce để phản hồi nhanh hơn
      updateEndpoint();

  // Debounced sync of custom phrases list with main query when Admin visible
      if (showAdmin) {
        if (cp_search) cp_search.value = v.trim();
        clearTimeout(window.__cpSyncTimer);
        window.__cpSyncTimer = setTimeout(() => {
          if (!editingId) {
            loadCustomPhrases({ resetPage: true }).catch(()=>{});
          }
        }, 250); // tăng tốc phản hồi
      }
    }

    q.addEventListener('input', onInput);
    q.addEventListener('focus', onInput);
    q.addEventListener('blur', () => setTimeout(() => list.style.display = 'none', 150));
    // Enter to search when dropdown không mở
    q.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        // Nếu list đang hiển thị & có active item thì on keydown handler dưới sẽ xử lý
        if (list.style.display !== 'block') {
          e.preventDefault();
          doSearch(1);
        }
      }
    });
  apiBase.addEventListener('input', () => updateEndpoint());

    // Restore arrow key navigation & Enter selection
    document.addEventListener('keydown', (e) => {
      if (document.activeElement !== q && e.target !== q) return; // only when focus in input
      if (list.style.display !== 'block') return;
      const max = (currentItemsCache || []).length;
      if (!max) return;
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        activeIndex = (activeIndex + 1 + max) % max;
        setList(currentItemsCache);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        activeIndex = (activeIndex - 1 + max) % max;
        setList(currentItemsCache);
      } else if (e.key === 'Enter') {
        if (activeIndex >= 0 && currentItemsCache[activeIndex]) {
          e.preventDefault();
          const it = currentItemsCache[activeIndex];
          q.value = it.full || it.text;
          if (autoTrackClick.checked) {
            trackSuggestClick(q.value, it).catch(()=>{});
          }
          list.style.display = 'none';
          doSearch(1);
        }
      } else if (e.key === 'Escape') {
        list.style.display = 'none';
      }
    });

    // Cache last items to keep highlight rendering stable across key navigation
    let currentItemsCache = [];
    const normalize = (s) => (s || '')
      .toLowerCase()
      .replace(/đ/g,'d')
      .replace(/Đ/g,'d')
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .replace(/[.,/#!$%^&*;:{}=\-_`~()\[\]'"+|<>?]/g, ' ')
      .replace(/\s+/g, ' ')
      .trim();
    function renderHighlight(it) {
      // Bôi đậm từng token người dùng đã gõ xuất hiện trong cụm gợi ý (không phân biệt hoa/thường & dấu)
      const queryRaw = (lastSpellChanged && lastCorrectedQuery) ? lastCorrectedQuery : (q.value || '');
      const phrase = String(it.full || it.text || '');
      if (!queryRaw.trim()) return escapeHtml(phrase);

      // Chuẩn hoá để so khớp (bỏ dấu tiếng Việt, ký tự đặc biệt -> space)
      const normalize = (s) => (s||'').toLowerCase()
        .replace(/đ/g,'d').replace(/Đ/g,'d')
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g,'')
        .replace(/[^a-z0-9àáạảãăằắặẳẵâầấậẩẫèéẹẻẽêềếệểễìíịỉĩòóọỏõôồốộổỗơờớợởỡùúụủũưừứựửữỳýỵỷỹđ\s]/g,' ')
        .replace(/\s+/g,' ') // collapse
        .trim();

      // Tokenize query (giữ thứ tự, loại token ngắn rỗng)
      const qTokens = normalize(queryRaw).split(' ').filter(t => t.length);
      if (!qTokens.length) return escapeHtml(phrase);

      // Duyệt phrase theo ký tự, tạo map vị trí các lần khớp token (ưu tiên dài hơn)
      const normPhrase = normalize(phrase);
      // Ta cần ánh xạ index trong normPhrase về index trong original phrase.
      // Cách đơn giản: tạo mảng mapChar từ normPhrase char -> original substring index.
      const originalChars = [...phrase];
      const lowered = phrase.toLowerCase();
      // Để đơn giản & vẫn chính xác phần lớn: Khi highlight ta dựa vào substring trong phiên bản thường (lowered) tìm trong lowered.

      // Sắp xếp token theo độ dài giảm để tránh lồng highlight ("thuc an" chứa "thuc")
      const sortedTokens = [...new Set(qTokens)].sort((a,b)=>b.length - a.length);

      // Ta sẽ xây dựng một mảng các đoạn {text, hit:boolean}
      const segments = [];
      let i = 0;
      const loweredNoAccent = normalize(lowered); // lowered đã bỏ dấu qua normalize()
      // Ta cũng cần mapping giữa loweredNoAccent và lowered (có dấu) để cắt theo index.
      // Tạo chuỗi loweredNoAccentFromOriginal đi từng char original => char đã normalize (chỉ lấy nhóm base)
      const map = []; // map index trong loweredNoAccent -> index bắt đầu trong phrase original
      const rebuilt = []; // rebuilt chuỗi từ original theo normalize char-by-char
      for (let oi=0; oi<phrase.length; oi++) {
        const ch = phrase[oi];
        const base = ch.normalize('NFD').replace(/[\u0300-\u036f]/g,'');
        for (const bc of base) {
          map.push(oi);
          let low = bc.toLowerCase();
          // fold ký tự đặc thù tiếng Việt 'đ' -> 'd' để đồng bộ với normalize() của query
          if (low === 'đ') low = 'd';
          rebuilt.push(low);
        }
      }
      const rebuiltStr = rebuilt.join('');

      // Đánh dấu các khoảng match trong rebuiltStr
      // Tạo array same length with false
      const mark = new Array(rebuiltStr.length).fill(false);
      for (const tok of sortedTokens) {
        if (!tok) continue;
        let start = 0;
        while (start < rebuiltStr.length) {
          const idx = rebuiltStr.indexOf(tok, start);
          if (idx === -1) break;
            // Kiểm tra ranh giới từ (trước & sau không phải chữ/ số) để tránh highlight bên trong từ dài khác
            const leftOk = idx === 0 || /[^a-z0-9]/.test(rebuiltStr[idx-1]);
            const rightPos = idx + tok.length;
            const rightOk = rightPos === rebuiltStr.length || /[^a-z0-9]/.test(rebuiltStr[rightPos]);
            if (leftOk && rightOk) {
              for (let k = idx; k < idx + tok.length; k++) mark[k] = true;
            }
            start = idx + tok.length; // tiếp tục sau match
        }
      }

      // Convert mark array thành segments dựa trên original phrase indexes
      let curHit = mark[0] || false;
      let segStart = 0;
      for (let pos=1; pos<=mark.length; pos++) {
        if (pos === mark.length || mark[pos] !== curHit) {
          // segment từ segStart..pos-1 trong rebuiltStr -> mapping sang original indexes
          const origStart = map[segStart];
          const origEnd = map[pos-1] + 1; // slice end
          const textSeg = phrase.slice(origStart, origEnd);
          segments.push({ text: textSeg, hit: curHit });
          segStart = pos;
          curHit = mark[pos];
        }
      }
      // Gộp lại thành HTML
      return segments.map(s => `<span class="${s.hit? 'suggest-hit':'suggest-frag'}">${escapeHtml(s.text)}</span>`).join('');
    }

    // Override setList to keep cache in sync
    const _setList = setList;
    setList = function(items) {
      currentItemsCache = items;
      _setList(items);
    }

    function updateEndpoint() {
      const base = (apiBase.value || '').replace(/\/$/, '') || 'https://pepeapi-vv2pcyowoa-as.a.run.app';
      const v = q.value || '';
      const qs = `?query=${encodeURIComponent(v)}`;
      endpointPreview.textContent = `GET ${base}/api/search/suggest_keywords${qs}`;
    }

    // Initialize endpoint preview once
    updateEndpoint();

    // Admin toggle: persist to localStorage
    const ADMIN_TOGGLE_KEY = 'showAdmin@autocomplete';
  const DARK_MODE_KEY = 'darkMode@autocomplete';
    function applyAdminVisibility(show) {
      adminSection.style.display = show ? 'block' : 'none';
      btnToggleAdmin.textContent = show ? 'Ẩn Admin' : 'Hiện Admin';
    }
    const savedShowAdmin = localStorage.getItem(ADMIN_TOGGLE_KEY);
    let showAdmin = savedShowAdmin === null ? false : savedShowAdmin === '1';
    applyAdminVisibility(showAdmin);
    // Auto collapse on mobile first load
    function isMobileWidth(){ return window.innerWidth < 780; }
    if (isMobileWidth()) {
      // Override to collapsed unless user explicitly enabled before
      if (savedShowAdmin === null) {
        showAdmin = false;
        applyAdminVisibility(false);
      }
    }
    if (showAdmin) {
      // preload list when visible
      loadCustomPhrases().catch(()=>{});
    }
    btnToggleAdmin?.addEventListener('click', () => {
      showAdmin = !showAdmin;
      applyAdminVisibility(showAdmin);
      localStorage.setItem(ADMIN_TOGGLE_KEY, showAdmin ? '1' : '0');
      if (showAdmin) {
        loadCustomPhrases().catch(()=>{});
      }
    });

    // Dark mode persistence
    const savedDark = localStorage.getItem(DARK_MODE_KEY);
    if (savedDark === '1') {
      document.body.classList.add('dark');
      if (btnDarkMode) btnDarkMode.textContent = 'Light';
    }
    btnDarkMode?.addEventListener('click', () => {
      const dark = document.body.classList.toggle('dark');
      localStorage.setItem(DARK_MODE_KEY, dark ? '1':'0');
      btnDarkMode.textContent = dark ? 'Light' : 'Dark';
    });

    window.addEventListener('resize', () => {
      if (isMobileWidth() && showAdmin && adminSection.style.display !== 'none') {
        // keep as user set; no force collapse after interaction
        return;
      }
    });

    // Helpers
    async function trackSuggestClick(qBefore, item) {
      const base = apiBase.value.replace(/\/$/, '');
      const url = `${base}/api/search/suggest_click`;
      const headers = { 'Content-Type': 'application/json' };
      const tk = token.value.trim();
      if (tk) headers['Authorization'] = tk.startsWith('Bearer ') ? tk : `Bearer ${tk}`;
      const body = {
        q: String(qBefore || ''),
        chosen: String(item?.full || item?.text || ''),
        token: String(item?.token || ''),
        type: String(item?.type || ''),
      };
      const res = await fetch(url, { method: 'POST', headers, body: JSON.stringify(body) });
      if (!res.ok) throw new Error('track click HTTP ' + res.status);
      return await res.json();
    }

    async function postNoBody(path) {
      const base = apiBase.value.replace(/\/$/, '');
      const url = `${base}${path}`;
      const headers = {};
      const tk = token.value.trim();
    if (tk) headers['Authorization'] = tk.startsWith('Bearer ') ? tk : `Bearer ${tk}`;
      const t0 = performance.now();
      const res = await fetch(url, { method: 'POST', headers });
      const dt = Math.round(performance.now() - t0);
      if (!res.ok) throw new Error(path + ' HTTP ' + res.status);
      const json = await res.json();
  showToast(`${path} OK (${dt}ms)`, { variant: 'success', title: 'Thành công' });
  console.log(path + ' response:', json?.data || json);
    }

  btnRebuildVectors?.addEventListener('click', () => postNoBody('/api/search/rebuild_keyword_vectors').catch(e => showToast('Lỗi: ' + e, { variant:'danger', title:'Lỗi'})));
  btnRebuildDict?.addEventListener('click', () => postNoBody('/api/search/rebuild_dictionary').catch(e => showToast('Lỗi: ' + e, { variant:'danger', title:'Lỗi'})));
  btnSearchNow?.addEventListener('click', async () => {
    try {
      const base = apiBase.value.replace(/\/$/, '');
      const qVal = (q.value || '').trim();
      if (!qVal) { showToast('Nhập từ khóa', { variant:'warning', title:'Thiếu'}); return; }
  const headers = { 'Accept':'application/json' };
      const tk = token.value.trim(); if (tk) headers['Authorization'] = tk.startsWith('Bearer ') ? tk : `Bearer ${tk}`;
      const url = `${base}/api/search?query=${encodeURIComponent(qVal)}`;
      const res = await fetch(url, { headers });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const js = await res.json();
      // Hiển thị tóm tắt kết quả + nếu có corrected
      const corrected = js.corrected && js.corrected !== qVal ? ` (đã sửa: ${js.corrected})` : '';
      showToast(`Search OK${corrected}. KQ: ${Array.isArray(js.data)? js.data.length: 0}`, { variant:'success', title:'Search' });
      console.log('[SEARCH]', js);
    } catch (e) {
      showToast('Lỗi search: ' + e, { variant:'danger', title:'Search'});
    }
  });

    btnStats1d?.addEventListener('click', async () => {
      try {
        const base = apiBase.value.replace(/\/$/, '');
        const url = new URL(`${base}/api/search/suggest_stats`);
        const now = new Date();
        const from = new Date(now.getTime() - 24 * 60 * 60 * 1000).toISOString();
        const to = now.toISOString();
        url.searchParams.set('from', from);
        url.searchParams.set('to', to);
        const headers = {};
        const tk = token.value.trim();
        if (tk) headers['Authorization'] = tk.startsWith('Bearer ') ? tk : `Bearer ${tk}`;
        const res = await fetch(url.toString(), { headers });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const json = await res.json();
  showToast('Suggest stats 24h nhận được (xem console)', { title: 'Stats', variant: 'info', duration: 6000 });
  console.log('Suggest stats 24h', json?.data || json);
      } catch (e) {
  showToast('Lỗi lấy stats: ' + String(e), { variant: 'danger', title: 'Lỗi' });
      }
    });

    // Admin: custom phrases (listeners using paginated loadCustomPhrases)

  cp_refresh?.addEventListener('click', () => loadCustomPhrases({}).catch(e => showToast('Lỗi: ' + String(e), { variant:'danger', title:'Lỗi'})));
    cp_limit?.addEventListener('change', () => loadCustomPhrases({ resetPage: true }).catch(e => console.warn(e)) );
    cp_prev?.addEventListener('click', () => { if (cpPage > 1) { cpPage--; loadCustomPhrases().catch(()=>{}); }});
    cp_next?.addEventListener('click', () => { if (cpPage < cpTotalPages) { cpPage++; loadCustomPhrases().catch(()=>{}); }});
    let cpSearchTimer;
    cp_search?.addEventListener('input', () => {
      clearTimeout(cpSearchTimer);
      cpSearchTimer = setTimeout(() => loadCustomPhrases({ resetPage: true }).catch(()=>{}), 350);
    });
    cp_clear_filter?.addEventListener('click', () => {
      if (cp_search) cp_search.value = '';
      loadCustomPhrases({ resetPage: true }).catch(()=>{});
    });
    cp_cancel?.addEventListener('click', () => {
      editingId = null;
      cp_add.textContent = 'Thêm/Update';
      cp_cancel.style.display = 'none';
  // removed cp_phrase reset
      cp_display.value = '';
    });

    cp_add?.addEventListener('click', async () => {
      try {
        const base = apiBase.value.replace(/\/$/, '');
        let url = `${base}/api/search/custom_phrases`;
        const headers = { 'Content-Type': 'application/json' };
        const tk = token.value.trim();
      if (tk) headers['Authorization'] = tk.startsWith('Bearer ') ? tk : `Bearer ${tk}`;
        const payload = {
          // phrase removed; backend derives tokens/phrase from display
          display: String(cp_display.value || ''),
          priority: parseFloat(cp_priority.value) || 1,
        };
  if (!payload.display.trim()) return showToast('Nhập Display', { variant:'warning', title:'Thiếu dữ liệu'});
        if (editingId) {
          // Update only with PUT (avoid POST fallback to prevent accidental new doc)
          // 1) PUT /custom_phrases with body.id
          let res = await fetch(url, { method: 'PUT', headers, body: JSON.stringify({ id: editingId, ...payload }) });
          // 2) Fallback: PUT /custom_phrases/:id
          if (!res.ok) {
            res = await fetch(`${url}/${encodeURIComponent(editingId)}`, { method: 'PUT', headers, body: JSON.stringify(payload) });
          }
          // 3) Fallback: PUT /custom_phrases?id=...
          if (!res.ok) {
            res = await fetch(`${url}?id=${encodeURIComponent(editingId)}`, { method: 'PUT', headers, body: JSON.stringify(payload) });
          }
          if (!res.ok) {
            const text = await res.text().catch(()=>'');
            throw new Error('Update thất bại: ' + res.status + (text? `\n${text}`:''));
          }
          showToast('Đã cập nhật', { variant:'success', title:'Thành công'});
        } else {
          const res = await fetch(url, { method: 'POST', headers, body: JSON.stringify(payload) });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          showToast('Đã thêm', { variant:'success', title:'Thành công'});
        }
        // reset form
        editingId = null;
        cp_add.textContent = 'Thêm/Update';
        cp_cancel.style.display = 'none';
  // removed cp_phrase reset
        cp_display.value = '';
  loadCustomPhrases({ resetPage: true }).catch(e => showToast('Lỗi tải danh sách: ' + String(e), { variant:'danger', title:'Lỗi'}));
      } catch (e) {
  showToast('Lỗi: ' + String(e), { variant:'danger', title:'Lỗi'});
      }
    });
      cp_search?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          cpPage = 1;
          loadCustomPhrases({ resetPage: true }).catch(()=>{});
        }
      });

    // Import file (.txt) — show instruction modal first
    cp_import?.addEventListener('click', () => {
      if (importModal && !hasImportAck()) {
        openImportModal();
      } else {
        if (cp_file) { cp_file.value=''; cp_file.click(); }
      }
    });
    cp_import_delete?.addEventListener('click', () => {
      if (importDelModal && !hasImportDelAck()) {
        openImportDelModal();
      } else {
        if (cp_delete_file) { cp_delete_file.value=''; cp_delete_file.click(); }
      }
    });
    cp_file?.addEventListener('change', async (ev) => {
      const file = ev.target.files?.[0];
      if (!file) return;
      try {
        const text = await file.text();
        const lines = text.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
  if (!lines.length) return showToast('File rỗng hoặc không có dòng hợp lệ', { variant:'warning', title:'Cảnh báo'});
        const unique = Array.from(new Set(lines));
        if (!confirm(`Import ${unique.length} dòng (bulk merge)?`)) return;
        const base = apiBase.value.replace(/\/$/, '');
        const url = `${base}/api/search/custom_phrases_bulk_merge`;
        const headers = { 'Content-Type': 'application/json' };
        const tk = token.value.trim();
        if (tk) headers['Authorization'] = tk.startsWith('Bearer ') ? tk : `Bearer ${tk}`;
        const prio = parseFloat(cp_priority.value) || 1;
        const t0 = performance.now();
        const res = await fetch(url, { method: 'POST', headers, body: JSON.stringify({ lines: unique, priority: prio }) });
        if (!res.ok) {
          const txt = await res.text().catch(()=> '');
          throw new Error('HTTP ' + res.status + (txt? ('\n'+txt):''));
        }
        const js = await res.json().catch(()=>({}));
        const d = js?.data || {};
        const dt = Math.round(performance.now() - t0);
  showToast(`Import bulk xong - Inserted: ${d.inserted || 0}, Merged: ${d.merged || 0}, Failed: ${d.failed || 0}`, { variant:'success', title:'Import'});
  console.log('Bulk import chi tiết', { ...d, uniqueCount: unique.length, latency: dt });
        await loadCustomPhrases({ resetPage: true });
      } catch (e) {
  showToast('Import lỗi: ' + String(e), { variant:'danger', title:'Lỗi'});
      } finally {
        ev.target.value = '';
      }
    });

    // Bulk delete import (.txt) — flexible resolve (phrase/display)
    cp_delete_file?.addEventListener('change', async (ev) => {
      const file = ev.target.files?.[0];
      if (!file) return;
      try {
        const text = await file.text();
        const lines = text.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
  if (!lines.length) return showToast('File rỗng hoặc không có dòng hợp lệ', { variant:'warning', title:'Cảnh báo'});
        if (!confirm(`Xoá theo file: ${lines.length} dòng?`)) return;
        const base = apiBase.value.replace(/\/$/, '');
  const headers = { 'Content-Type': 'application/json' };
        const tk = token.value.trim();
        if (tk) headers['Authorization'] = tk.startsWith('Bearer ') ? tk : `Bearer ${tk}`;
  let deleted = 0, notFound = [], failed = [];
        const t0 = performance.now();
        async function resolveId(line){
          try {
            const qUrl = `${base}/api/search/custom_phrases?q=${encodeURIComponent(line)}&limit=20&page=1`;
            const res = await fetch(qUrl, { headers });
            if (!res.ok) return { id: null, phrase: line };
            const js = await res.json();
            const rows = js?.data || [];
            if (!rows.length) return { id: null, phrase: line };
            const fold = (s)=> (s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
            const lineFold = fold(line);
            let cand = rows.find(r => fold(r.phrase||'') === lineFold);
            if (!cand) cand = rows.find(r => fold(r.display||'') === lineFold);
            if (!cand) cand = rows[0];
            const id = cand._id || cand.id || cand.pk || cand.phrase;
            return { id, phrase: cand.phrase || line };
          } catch { return { id: null, phrase: line }; }
        }
        const chunkSize = 10;
        for (let i = 0; i < lines.length; i += chunkSize) {
          const chunk = lines.slice(i, i + chunkSize);
            await Promise.all(chunk.map(async line => {
              const { id } = await resolveId(line);
              const delBody = { id: id || line };
              try {
                const res = await fetch(`${base}/api/search/custom_phrases`, { method: 'DELETE', headers, body: JSON.stringify(delBody) });
                if (res.ok) {
                  deleted++; return;
                }
                // fallback query param
                const res2 = await fetch(`${base}/api/search/custom_phrases?id=${encodeURIComponent(id || line)}`, { method: 'DELETE', headers });
                if (res2.ok) { deleted++; return; }
                // fallback path param
                const res3 = await fetch(`${base}/api/search/custom_phrases/${encodeURIComponent(id || line)}`, { method: 'DELETE', headers });
                if (res3.ok) { deleted++; return; }
                if (res.status === 404 || res2.status === 404 || res3.status === 404) notFound.push(line); else failed.push(line);
              } catch { failed.push(line); }
            }));
        }
        const dt = Math.round(performance.now() - t0);
        let msg = `Xoá xong: ${deleted} OK / ${lines.length}\n`;
        if (notFound.length) msg += `Not found (${notFound.length}): ${notFound.slice(0,5).join(', ')}${notFound.length>5?' ...':''}\n`;
        if (failed.length) msg += `Failed (${failed.length}): ${failed.slice(0,5).join(', ')}${failed.length>5?' ...':''}\n`;
        msg += `Latency: ${dt}ms`;
  showToast(msg, { variant:'success', title:'Xoá bulk'});
        await loadCustomPhrases();
      } catch (e) {
  showToast('Import xoá lỗi: ' + String(e), { variant:'danger', title:'Lỗi'});
      } finally {
        ev.target.value = '';
      }
    });

    // Search and pagination
    async function fetchSearch(query, page, limit) {
      const base = apiBase.value.replace(/\/$/, '');
      const params = new URLSearchParams({
        query: query,
        sort: 'related_score desc',
        limit: String(limit),
        page: String(page),
      });
      const url = `${base}/api/search?${params.toString()}`;
      const headers = {};
      const tk = token.value.trim();
    if (tk) headers['Authorization'] = tk.startsWith('Bearer ') ? tk : `Bearer ${tk}`;
      const res = await fetch(url, { headers });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const json = await res.json();
      return json?.data || [];
    }

    async function doSearch(page = 1) {
      const query = (q.value || '').trim();
      if (!query) return;
      const limit = parseInt(limitSel.value, 10) || 10;
      try {
        const [rows, didYouMean] = await Promise.all([
          fetchSearch(query, page, limit),
          fetchTypoSuggest(query)
        ]);
        currentPage = page;
        pageNum.textContent = String(currentPage);
        queryEcho.textContent = `cho \u201C${query}\u201D`;
        renderResults(rows);
        resultsWrap.style.display = 'block';
        nextBtn.disabled = rows.length < limit;
        prevBtn.disabled = currentPage <= 1;
        if (didYouMean && didYouMean.toLowerCase() !== query.toLowerCase()) {
          didYouMeanWrap.style.display = 'block';
          //didYouMeanWrap.innerHTML = `Gợi ý: Có phải bạn muốn tìm “<a id=\"dymLink\" href=\"#\">${escapeHtml(didYouMean)}</a>”?`;
          const link = document.getElementById('dymLink');
          link?.addEventListener('click', (e) => {
            e.preventDefault();
            q.value = didYouMean;
            doSearch(1);
          });
        } else {
          didYouMeanWrap.style.display = 'none';
          didYouMeanWrap.innerHTML = '';
        }
      } catch (err) {
        console.error('Search error', err);
      }
    }

    function renderResults(rows) {
      results.innerHTML = '';
      rows.forEach((p) => {
        const card = document.createElement('div');
        card.className = 'result-card';
        const title = escapeHtml(p.title || p.name || '');
        const brand = escapeHtml(p.brand?.text || p.brand || '');
        const price = p.selling_price ?? p.price_promotion ?? p.price;
        const img = p.images || p.units?.[0]?.main_image;
        card.innerHTML = `
          <div class="result-content">
            ${img ? `<img class="result-img" src="${img}" alt="${title}" />` : ''}
            <div class="result-main" style="flex:1; min-width:0;">
              <div class="result-title">${title}</div>
              <div class="result-meta">${brand}</div>
              <div class="result-price">${price ? price.toLocaleString('vi-VN') + ' đ' : ''}</div>
            </div>
          </div>
        `;
        results.appendChild(card);
      });
    }

    prevBtn?.addEventListener('click', () => {
      if (currentPage > 1) doSearch(currentPage - 1);
    });
    nextBtn?.addEventListener('click', () => {
      doSearch(currentPage + 1);
    });

    async function fetchTypoSuggest(query) {
      const base = apiBase.value.replace(/\/$/, '');
      const url = `${base}/api/search/typo_suggest?query=${encodeURIComponent(query)}`;
      const headers = {};
      const tk = token.value.trim();
    if (tk) headers['Authorization'] = tk.startsWith('Bearer ') ? tk : `Bearer ${tk}`;
      try {
        const res = await fetch(url, { headers });
        if (!res.ok) return null;
        const json = await res.json();
        // API trả về { data: { did_you_mean, tokens, correctedTokens } }
        return json?.data?.did_you_mean || null;
      } catch {
        return null;
      }
    }

    // Delete with fallbacks and detailed error (try JSON body first for robust backend handling)
    async function deleteCustomPhrase(id) {
      const base = apiBase.value.replace(/\/$/, '');
      const headers = { };
      const tk = token.value.trim();
      if (tk) headers['Authorization'] = tk.startsWith('Bearer ') ? tk : `Bearer ${tk}`;

      const errors = [];
      // Try DELETE with body first
      const headersJson = { ...headers, 'Content-Type': 'application/json' };
      let res = await fetch(`${base}/api/search/custom_phrases`, { method: 'DELETE', headers: headersJson, body: JSON.stringify({ id }) });
      if (res.ok) return true; else errors.push(`body{id} -> ${res.status}` + ' ' + await res.text().catch(()=>''));
      // Then query param
      res = await fetch(`${base}/api/search/custom_phrases?id=${encodeURIComponent(id)}`, { method: 'DELETE', headers });
      if (res.ok) return true; else errors.push(`?id -> ${res.status}` + ' ' + await res.text().catch(()=>''));
      // Try DELETE with path param
      res = await fetch(`${base}/api/search/custom_phrases/${encodeURIComponent(id)}`, { method: 'DELETE', headers });
      if (res.ok) return true; else errors.push(`/:id -> ${res.status}` + ' ' + await res.text().catch(()=>''));
  showToast('Xoá thất bại ID ' + id + ' (xem console)', { variant:'danger', title:'Lỗi'});
  console.error('Chi tiết lỗi xoá', { id, errors });
      return false;
    }
  </script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
  <!-- jQuery toast plugin removed -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>